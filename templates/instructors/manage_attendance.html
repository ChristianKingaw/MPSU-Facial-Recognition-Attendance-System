{% extends "instructor_layout.html" %}

{% block title %}Manage Student Attendance{% endblock %}

{% block content %}
<!-- Class Attendance Overview -->
<div id="classOverview">
    <h2>Class Attendance</h2>
    <div class="table-responsive">
        <table class="table table-bordered">
            <thead class="table-light">
                <tr>
                    <th>Class Code</th>
                    <th>Course Description</th>
                    <th>Students</th>
                    <th>Schedule</th>
                    <th>Date</th>
                    <th>Attended</th>
                </tr>
            </thead>
            <tbody id="class-overview-tbody">
                <tr>
                    <td colspan="6" class="text-center">Loading classes...</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- Class Detail View -->
<div id="classDetailView" style="display:none;">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 id="classDetailTitle">Class: </h2>
            <h5 id="classDetailCode">Class Code: </h5>
        </div>
        <button class="btn btn-primary back-button" id="backToOverview">&#8592; Back</button>
    </div>
    
    <div class="attendance-summary mb-4">
        <div class="attendance-counter present">
            <span class="counter-icon"><i class="fas fa-user-check"></i></span>
            <span id="presentCount">0</span> Present
        </div>
        <div class="attendance-counter absent">
            <span class="counter-icon"><i class="fas fa-user-times"></i></span>
            <span id="absentCount">0</span> Absent
        </div>
    </div>
    
    <div class="table-responsive">
        <table class="table table-bordered">
            <thead class="table-light">
                <tr>
                    <th>Student</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="class-detail-tbody">
                <tr>
                    <td colspan="3" class="text-center">Loading students...</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- Student Detail View -->
<div id="studentDetailView" style="display:none;">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 id="studentDetailTitle">Student: </h2>
            <h5 id="studentDetailClass">Class: </h5>
        </div>
        <button class="btn btn-primary back-button" id="backToClassDetail">&#8592; Back</button>
    </div>
    
    <div class="attendance-summary mb-4">
        <div class="attendance-counter present">
            <span class="counter-icon"><i class="fas fa-user-check"></i></span>
            <span id="studentPresentCount">0</span> Present
        </div>
        <div class="attendance-counter absent">
            <span class="counter-icon"><i class="fas fa-user-times"></i></span>
            <span id="studentAbsentCount">0</span> Absent
        </div>
    </div>
    
    <div class="table-responsive">
        <table class="table table-bordered">
            <thead class="table-light">
                <tr>
                    <th>Date</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="studentDatesBody">
                <tr>
                    <td colspan="3" class="text-center">Loading attendance records...</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Global variables to track state
let currentClassId = null;
let currentStudentId = null;

document.addEventListener('DOMContentLoaded', function() {
    // Set up event listeners
    document.getElementById('backToOverview').addEventListener('click', showClassOverview);
    document.getElementById('backToClassDetail').addEventListener('click', () => {
        showClassDetail(currentClassId);
    });
    
    // Load class overview
    loadClassOverview();
    
    // Event delegation for dynamically created elements
    document.addEventListener('click', function(e) {
        // Class link in overview
        if (e.target.closest('.course-link')) {
            const link = e.target.closest('.course-link');
            showClassDetail(link.dataset.classId);
        }
        
        // Student link in class detail
        if (e.target.closest('.student-link')) {
            const link = e.target.closest('.student-link');
            showStudentDetail(link.dataset.studentId, currentClassId);
        }
        
        // Toggle attendance status button
        if (e.target.closest('.toggle-status-btn')) {
            const btn = e.target.closest('.toggle-status-btn');
            const studentId = btn.dataset.studentId;
            const date = btn.dataset.date || new Date().toISOString().split('T')[0];
            const currentStatus = btn.dataset.currentStatus;
            const newStatus = currentStatus === 'Present' ? 'Absent' : 'Present';
            
            updateAttendanceStatus(currentClassId, studentId, date, newStatus);
        }
    });
});

// Load class overview data
async function loadClassOverview() {
    try {
        const response = await fetch('/instructors/api/class-attendance-overview');
        const classes = await response.json();
        
        const tbody = document.getElementById('class-overview-tbody');
        tbody.innerHTML = '';
        
        if (classes.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center">No classes found</td></tr>';
            return;
        }
        
        classes.forEach(cls => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${cls.classCode}</td>
                <td><a href="#" class="course-link" data-class-id="${cls.id}">${cls.description}</a></td>
                <td>${cls.enrolledCount}</td>
                <td>${cls.schedule}</td>
                <td>${cls.date}</td>
                <td>${cls.presentCount} out of ${cls.enrolledCount}</td>
            `;
            tbody.appendChild(row);
        });
    } catch (error) {
        console.error('Error loading class overview:', error);
        document.getElementById('class-overview-tbody').innerHTML = 
            '<tr><td colspan="6" class="text-center text-danger">Error loading classes. Please try again later.</td></tr>';
    }
}

// Show class overview - the main view
function showClassOverview() {
    document.getElementById('classOverview').style.display = 'block';
    document.getElementById('classDetailView').style.display = 'none';
    document.getElementById('studentDetailView').style.display = 'none';
    currentClassId = null;
    currentStudentId = null;
}

// Show class detail view with students
async function showClassDetail(classId) {
    currentClassId = classId;
    
    try {
        // Get class details
        const classResponse = await fetch(`/classes/api/${classId}`);
        const classData = await classResponse.json();
        
        // Update header
        document.getElementById('classDetailTitle').textContent = `Class: ${classData.description}`;
        document.getElementById('classDetailCode').textContent = `Class Code: ${classData.classCode}`;
        
        // Get students in this class with attendance status
        const studentsResponse = await fetch(`/instructors/api/class-students/${classId}`);
        const students = await studentsResponse.json();
        
        // Update attendance counters
        const presentCount = students.filter(s => s.status === 'Present').length;
        const absentCount = students.filter(s => s.status === 'Absent').length;
        
        document.getElementById('presentCount').textContent = presentCount;
        document.getElementById('absentCount').textContent = absentCount;
        
        // Populate students table
        const tbody = document.getElementById('class-detail-tbody');
        tbody.innerHTML = '';
        
        if (students.length === 0) {
            tbody.innerHTML = '<tr><td colspan="3" class="text-center">No students enrolled in this class</td></tr>';
        } else {
            students.forEach(student => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><a href="#" class="student-link" data-student-id="${student.id}">${student.name}</a></td>
                    <td class="${student.status === 'Present' ? 'present-status' : 'absent-status'}">${student.status}</td>
                    <td>
                        <button class="btn btn-sm ${student.status === 'Present' ? 'btn-danger' : 'btn-success'} toggle-status-btn"
                                data-student-id="${student.id}"
                                data-current-status="${student.status}">
                            ${student.status === 'Present' ? 'Mark Absent' : 'Mark Present'}
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        // Show class detail view
        document.getElementById('classOverview').style.display = 'none';
        document.getElementById('classDetailView').style.display = 'block';
        document.getElementById('studentDetailView').style.display = 'none';
    } catch (error) {
        console.error('Error loading class detail:', error);
        alert('Error loading class detail. Please try again.');
    }
}

// Show student detail view with attendance records
async function showStudentDetail(studentId, classId) {
    currentStudentId = studentId;
    
    try {
        // Get student attendance details
        const response = await fetch(`/instructors/api/student-attendance/${studentId}/${classId}`);
        const data = await response.json();
        
        // Update header
        document.getElementById('studentDetailTitle').textContent = `Student: ${data.student.name}`;
        document.getElementById('studentDetailClass').textContent = `Class: ${data.class.description} (${data.class.code})`;
        
        // Update attendance counters
        document.getElementById('studentPresentCount').textContent = data.attendance.presentCount;
        document.getElementById('studentAbsentCount').textContent = data.attendance.absentCount;
        
        // Create attendance records
        const tbody = document.getElementById('studentDatesBody');
        tbody.innerHTML = '';
        
        // Get all dates from the attendance records
        const dates = Object.keys(data.attendance.records).sort((a, b) => new Date(a) - new Date(b));
        
        if (dates.length === 0) {
            tbody.innerHTML = '<tr><td colspan="3" class="text-center">No attendance records found</td></tr>';
        } else {
            dates.forEach(date => {
                const status = data.attendance.records[date];
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${date}</td>
                    <td class="${status === 'Present' ? 'present-status' : 'absent-status'}">${status}</td>
                    <td>
                        <button class="btn btn-sm ${status === 'Present' ? 'btn-danger' : 'btn-success'} toggle-status-btn"
                                data-student-id="${studentId}"
                                data-date="${date}"
                                data-current-status="${status}">
                            ${status === 'Present' ? 'Mark Absent' : 'Mark Present'}
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        // Show student detail view
        document.getElementById('classOverview').style.display = 'none';
        document.getElementById('classDetailView').style.display = 'none';
        document.getElementById('studentDetailView').style.display = 'block';
    } catch (error) {
        console.error('Error loading student attendance:', error);
        alert('Error loading student attendance. Please try again.');
    }
}

// Update attendance status
async function updateAttendanceStatus(classId, studentId, date, status) {
    try {
        const response = await fetch('/instructors/api/update-attendance', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                classId: classId,
                studentId: studentId,
                date: date,
                status: status
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            // If we're in student detail view, refresh it
            if (document.getElementById('studentDetailView').style.display !== 'none') {
                showStudentDetail(studentId, classId);
            } 
            // If we're in class detail view, refresh it
            else if (document.getElementById('classDetailView').style.display !== 'none') {
                showClassDetail(classId);
            }
        } else {
            alert(`Error updating attendance: ${result.message}`);
        }
    } catch (error) {
        console.error('Error updating attendance:', error);
        alert('Error updating attendance. Please try again.');
    }
}
</script>
{% endblock %}