{% extends "instructor_layout.html" %}

{% block title %}Class Schedule{% endblock %}

{% block content %}
<!-- Classes View -->
<div id="classes-view">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Class</h2>
        <div class="search-box">
            <div class="input-group">
                <input type="text" class="form-control" placeholder="Search" aria-label="Search" id="class-search">
                <button class="btn btn-outline-secondary" type="button">
                    <i class="fas fa-search"></i>
                </button>
            </div>
        </div>
    </div>

    <div class="table-responsive">
        <table class="table">
            <thead>
                <tr>
                    <th>Description</th>
                    <th>Room Number</th>
                    <th>Schedule</th>
                    <th>Number of Students</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="classes-list">
                <tr>
                    <td colspan="5" class="text-center">Loading classes...</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- Class Detail View -->
<div id="class-detail-view" class="d-none">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div class="d-flex align-items-center">
            <button id="back-to-classes" class="btn btn-primary me-3">
                <i class="fas fa-arrow-left"></i> Back
            </button>
            <h2 id="class-detail-title">Class Name</h2>
        </div>
        <div class="search-box">
            <div class="input-group">
                <input type="text" class="form-control" placeholder="Search" aria-label="Search" id="student-search">
                <button class="btn btn-outline-secondary" type="button">
                    <i class="fas fa-search"></i>
                </button>
            </div>
        </div>
    </div>

    <div class="text-end mb-3">
        <button id="enroll-student-btn" class="btn btn-success">
            <i class="fas fa-plus"></i> Enroll Student
        </button>
    </div>

    <div class="table-responsive">
        <table class="table">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>ID Number</th>
                    <th>Year Level</th>
                    <th>Phone Number</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="enrolled-students-list">
                <!-- Enrolled students will be populated here dynamically -->
            </tbody>
        </table>
    </div>
</div>

<!-- Student Selection View -->
<div id="student-selection-view" class="d-none">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div class="d-flex align-items-center">
            <button id="back-to-class-detail" class="btn btn-primary me-3">
                <i class="fas fa-arrow-left"></i> Back
            </button>
            <h2>Enrolled Students</h2>
        </div>
        <div class="search-box">
            <div class="input-group">
                <input type="text" class="form-control" placeholder="Search" aria-label="Search" id="all-students-search">
                <button class="btn btn-outline-secondary" type="button">
                    <i class="fas fa-search"></i>
                </button>
            </div>
        </div>
    </div>

    <div class="table-responsive">
        <table class="table">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>ID Number</th>
                    <th>Year Level</th>
                    <th>Phone Number</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody id="all-students-list">
                <!-- All students will be populated here dynamically -->
            </tbody>
        </table>
    </div>
</div>

<!-- Confirmation Modal -->
<div class="modal-overlay" id="confirmation-modal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-body text-center">
                <h4>Are You Sure?</h4>
                <p id="confirmation-message">Do you want to unenroll this student from the class?</p>
                <div class="confirmation-buttons">
                    <button id="confirm-yes" class="btn btn-yes">Yes</button>
                    <button id="confirm-no" class="btn btn-no">No</button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Global variables to track state
let currentClassId = null;
let studentToUnenroll = null;

// DOM Ready
document.addEventListener('DOMContentLoaded', function() {
    // Event listeners for navigation
    document.getElementById('back-to-classes').addEventListener('click', showClassesView);
    document.getElementById('back-to-class-detail').addEventListener('click', () => {
        showClassDetailView(currentClassId);
    });
    document.getElementById('enroll-student-btn').addEventListener('click', showStudentSelectionView);
    
    // Event listeners for confirmation modal
    document.getElementById('confirm-yes').addEventListener('click', handleConfirmUnenroll);
    document.getElementById('confirm-no').addEventListener('click', () => {
        document.getElementById('confirmation-modal').classList.remove('show');
    });
    
    // Event delegation for dynamically created elements
    document.addEventListener('click', function(e) {
        // View class button
        if (e.target.closest('.view-class')) {
            const btn = e.target.closest('.view-class');
            const classId = btn.dataset.classId;
            showClassDetailView(classId);
        }
        
        // Unenroll button
        if (e.target.closest('.unenroll-btn')) {
            const btn = e.target.closest('.unenroll-btn');
            studentToUnenroll = {
                classId: currentClassId,
                studentId: btn.dataset.studentId
            };
            document.getElementById('confirmation-modal').classList.add('show');
        }
        
        // Enroll button in student selection view
        if (e.target.closest('.enroll-btn')) {
            const btn = e.target.closest('.enroll-btn');
            enrollStudent(btn.dataset.studentId);
        }
    });
    
    // Search functionality
    document.getElementById('class-search').addEventListener('input', function(e) {
        filterClasses(e.target.value);
    });
    
    document.getElementById('student-search').addEventListener('input', function(e) {
        filterStudents(e.target.value, 'enrolled-students-list');
    });
    
    document.getElementById('all-students-search').addEventListener('input', function(e) {
        filterStudents(e.target.value, 'all-students-list');
    });
    
    // Initialize the view
    showClassesView();
});

// Show Classes View
async function showClassesView() {
    document.getElementById('classes-view').classList.remove('d-none');
    document.getElementById('class-detail-view').classList.add('d-none');
    document.getElementById('student-selection-view').classList.add('d-none');
    currentClassId = null;

    try {
        const response = await fetch('/instructors/api/my-classes');
        const classes = await response.json();
        
        const tableBody = document.getElementById('classes-list');
        tableBody.innerHTML = '';
        
        if (classes.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="5" class="text-center">No classes assigned</td></tr>';
            return;
        }
        
        classes.forEach(classData => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${classData.description}</td>
                <td>${classData.roomNumber}</td>
                <td>${classData.schedule}</td>
                <td>${classData.enrolledCount}</td>
                <td>
                    <button class="btn btn-light view-class" data-class-id="${classData.id}" data-class-name="${classData.description}">
                        <i class="fas fa-eye"></i>
                    </button>
                </td>
            `;
            tableBody.appendChild(row);
        });
    } catch (error) {
        console.error('Error fetching classes:', error);
        document.getElementById('classes-list').innerHTML = 
            '<tr><td colspan="5" class="text-center text-danger">Error loading classes. Please try again later.</td></tr>';
    }
}

// Show Class Detail View
async function showClassDetailView(classId) {
    currentClassId = classId;
    
    try {
        // Get class details
        const classResponse = await fetch(`/classes/api/${classId}`);
        const classData = await classResponse.json();
        
        document.getElementById('class-detail-title').textContent = classData.description;

        // Get students enrolled in this class
        const studentsResponse = await fetch(`/classes/api/${classId}/students`);
        const students = await studentsResponse.json();
        
        const studentsList = document.getElementById('enrolled-students-list');
        studentsList.innerHTML = '';

        if (students.length === 0) {
            studentsList.innerHTML = '<tr><td colspan="5" class="text-center">No students enrolled</td></tr>';
        } else {
            students.forEach(student => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${student.firstName} ${student.lastName}</td>
                    <td>${student.id}</td>
                    <td>${student.yearLevel}</td>
                    <td>${student.phone}</td>
                    <td>
                        <button class="btn btn-danger unenroll-btn" data-student-id="${student.id}">
                            Unenroll
                        </button>
                    </td>
                `;
                studentsList.appendChild(row);
            });
        }

        document.getElementById('classes-view').classList.add('d-none');
        document.getElementById('class-detail-view').classList.remove('d-none');
        document.getElementById('student-selection-view').classList.add('d-none');
    } catch (error) {
        console.error('Error loading class details:', error);
        alert('Error loading class details. Please try again.');
    }
}

// Show Student Selection View
async function showStudentSelectionView() {
    try {
        // Get all students
        const allStudentsResponse = await fetch('/students/api/list');
        const allStudents = await allStudentsResponse.json();
        
        // Get enrolled students
        const enrolledResponse = await fetch(`/classes/api/${currentClassId}/students`);
        const enrolledStudents = await enrolledResponse.json();
        
        // Create map of enrolled student IDs for quick lookup
        const enrolledStudentIds = new Set(enrolledStudents.map(s => s.id));
        
        const studentsList = document.getElementById('all-students-list');
        studentsList.innerHTML = '';

        if (allStudents.length === 0) {
            studentsList.innerHTML = '<tr><td colspan="5" class="text-center">No students found</td></tr>';
        } else {
            allStudents.forEach(student => {
                const isEnrolled = enrolledStudentIds.has(student.id);
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${student.firstName} ${student.lastName}</td>
                    <td>${student.id}</td>
                    <td>${student.yearLevel}</td>
                    <td>${student.phone}</td>
                    <td>
                        ${isEnrolled ? 
                            '<button class="btn btn-secondary" disabled>Enrolled</button>' :
                            `<button class="btn btn-success enroll-btn" data-student-id="${student.id}">Enroll</button>`
                        }
                    </td>
                `;
                studentsList.appendChild(row);
            });
        }

        document.getElementById('classes-view').classList.add('d-none');
        document.getElementById('class-detail-view').classList.add('d-none');
        document.getElementById('student-selection-view').classList.remove('d-none');
    } catch (error) {
        console.error('Error loading students:', error);
        alert('Error loading students. Please try again.');
    }
}

// Handle confirmation of unenrolling a student
async function handleConfirmUnenroll() {
    if (studentToUnenroll) {
        try {
            const response = await fetch('/classes/api/unenroll', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    studentId: studentToUnenroll.studentId,
                    classId: studentToUnenroll.classId
                })
            });
            
            const result = await response.json();
            
            if (result.success) {
                // Hide confirmation modal
                document.getElementById('confirmation-modal').classList.remove('show');
                
                // Refresh the view
                showClassDetailView(studentToUnenroll.classId);
                
                // Reset
                studentToUnenroll = null;
            } else {
                alert(`Error: ${result.message}`);
            }
        } catch (error) {
            console.error('Error unenrolling student:', error);
            alert('Error unenrolling student. Please try again.');
        }
    }
}

// Enroll a student to the current class
async function enrollStudent(studentId) {
    try {
        const response = await fetch(`/classes/api/${currentClassId}/enroll`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                studentId: studentId
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Refresh the view
            showStudentSelectionView();
        } else {
            alert(`Error: ${result.message}`);
        }
    } catch (error) {
        console.error('Error enrolling student:', error);
        alert('Error enrolling student. Please try again.');
    }
}

// Filter the classes table based on search input
function filterClasses(searchTerm) {
    const rows = document.getElementById('classes-list').getElementsByTagName('tr');
    searchTerm = searchTerm.toLowerCase();
    
    for (let i = 0; i < rows.length; i++) {
        const row = rows[i];
        // Skip if this is a no-classes-found row
        if (row.cells.length === 1) continue;
        
        const description = row.cells[0].textContent.toLowerCase();
        const roomNumber = row.cells[1].textContent.toLowerCase();
        const schedule = row.cells[2].textContent.toLowerCase();
        
        if (description.includes(searchTerm) || 
            roomNumber.includes(searchTerm) || 
            schedule.includes(searchTerm)) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    }
}

// Filter students table based on search input
function filterStudents(searchTerm, tableId) {
    const rows = document.getElementById(tableId).getElementsByTagName('tr');
    searchTerm = searchTerm.toLowerCase();
    
    for (let i = 0; i < rows.length; i++) {
        const row = rows[i];
        // Skip if this is a no-students-found row
        if (row.cells.length === 1) continue;
        
        const name = row.cells[0].textContent.toLowerCase();
        const id = row.cells[1].textContent.toLowerCase();
        const yearLevel = row.cells[2].textContent.toLowerCase();
        const phone = row.cells[3].textContent.toLowerCase();
        
        if (name.includes(searchTerm) || 
            id.includes(searchTerm) || 
            yearLevel.includes(searchTerm) || 
            phone.includes(searchTerm)) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    }
}
</script>
{% endblock %}