{% extends "instructor_layout.html" %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <h1 class="mb-4">Welcome, {{ current_user.first_name }}</h1>
    
    <div class="row mb-4">
        <div class="col-md-6 col-lg-3 mb-3">
            <div class="card shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted mb-1">My Classes</h6>
                            <h3 class="mb-0" id="classCount">0</h3>
                        </div>
                        <div class="icon-shape bg-primary text-white rounded-circle shadow p-3">
                            <i class="fas fa-chalkboard"></i>
                        </div>
                    </div>
                </div>
                <div class="card-footer py-2">
                    <a href="{{ url_for('instructors.class_schedule') }}" class="text-decoration-none">
                        View Classes <i class="fas fa-arrow-right ms-1"></i>
                    </a>
                </div>
            </div>
        </div>
        
        <div class="col-md-6 col-lg-3 mb-3">
            <div class="card shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted mb-1">My Students</h6>
                            <h3 class="mb-0" id="studentCount">0</h3>
                        </div>
                        <div class="icon-shape bg-success text-white rounded-circle shadow p-3">
                            <i class="fas fa-user-graduate"></i>
                        </div>
                    </div>
                </div>
                <div class="card-footer py-2">
                    <a href="{{ url_for('instructors.enroll_student') }}" class="text-decoration-none">
                        Enroll Students <i class="fas fa-arrow-right ms-1"></i>
                    </a>
                </div>
            </div>
        </div>
        
        <div class="col-md-6 col-lg-3 mb-3">
            <div class="card shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted mb-1">Present Today</h6>
                            <h3 class="mb-0" id="presentCount">0</h3>
                        </div>
                        <div class="icon-shape bg-info text-white rounded-circle shadow p-3">
                            <i class="fas fa-user-check"></i>
                        </div>
                    </div>
                </div>
                <div class="card-footer py-2">
                    <a href="{{ url_for('instructors.manage_attendance') }}" class="text-decoration-none">
                        Manage Attendance <i class="fas fa-arrow-right ms-1"></i>
                    </a>
                </div>
            </div>
        </div>
        
        <div class="col-md-6 col-lg-3 mb-3">
            <div class="card shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted mb-1">Absent Today</h6>
                            <h3 class="mb-0" id="absentCount">0</h3>
                        </div>
                        <div class="icon-shape bg-danger text-white rounded-circle shadow p-3">
                            <i class="fas fa-user-times"></i>
                        </div>
                    </div>
                </div>
                <div class="card-footer py-2">
                    <a href="{{ url_for('instructors.manage_attendance') }}" class="text-decoration-none">
                        Manage Attendance <i class="fas fa-arrow-right ms-1"></i>
                    </a>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row">
        <div class="col-lg-6 mb-4">
            <div class="card shadow-sm">
                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">My Classes</h5>
                    <a href="{{ url_for('instructors.class_schedule') }}" class="btn btn-sm btn-primary">View All</a>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead>
                                <tr>
                                    <th>Class</th>
                                    <th>Room</th>
                                    <th>Schedule</th>
                                    <th>Students</th>
                                </tr>
                            </thead>
                            <tbody id="classesList">
                                <tr>
                                    <td colspan="4" class="text-center">Loading classes...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-6 mb-4">
            <div class="card shadow-sm">
                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Recent Students</h5>
                    <a href="{{ url_for('instructors.enroll_student') }}" class="btn btn-sm btn-primary">View All</a>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>ID</th>
                                    <th>Year Level</th>
                                    <th>Classes</th>
                                </tr>
                            </thead>
                            <tbody id="studentsList">
                                <tr>
                                    <td colspan="4" class="text-center">Loading students...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .icon-shape {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        text-align: center;
        border-radius: 50%;
        width: 50px;
        height: 50px;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Load dashboard data
    loadDashboardData();
    
    // Set the current date
    const today = new Date();
    const formattedDate = today.toLocaleDateString('en-US', { 
        weekday: 'long', 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
    });
    
    function loadDashboardData() {
        // Load classes
        fetch('/instructors/api/my-classes')
            .then(response => response.json())
            .then(classes => {
                // Update class count
                document.getElementById('classCount').textContent = classes.length;
                
                // Update classes table
                const classesList = document.getElementById('classesList');
                classesList.innerHTML = '';
                
                if (classes.length === 0) {
                    classesList.innerHTML = '<tr><td colspan="4" class="text-center">No classes assigned</td></tr>';
                } else {
                    // Show only up to 5 classes in dashboard
                    const classesToShow = classes.slice(0, 5);
                    classesToShow.forEach(classData => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${classData.description}</td>
                            <td>${classData.roomNumber}</td>
                            <td>${classData.schedule}</td>
                            <td>${classData.enrolledCount}</td>
                        `;
                        classesList.appendChild(row);
                    });
                }
            })
            .catch(error => {
                console.error('Error loading classes:', error);
                document.getElementById('classesList').innerHTML = 
                    '<tr><td colspan="4" class="text-center text-danger">Error loading classes</td></tr>';
            });
        
        // Load students
        fetch('/instructors/api/my-students')
            .then(response => response.json())
            .then(students => {
                // Update student count
                document.getElementById('studentCount').textContent = students.length;
                
                // Update students table
                const studentsList = document.getElementById('studentsList');
                studentsList.innerHTML = '';
                
                if (students.length === 0) {
                    studentsList.innerHTML = '<tr><td colspan="4" class="text-center">No students enrolled</td></tr>';
                } else {
                    // Show only up to 5 students in dashboard
                    const studentsToShow = students.slice(0, 5);
                    studentsToShow.forEach(student => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${student.firstName} ${student.lastName}</td>
                            <td>${student.id}</td>
                            <td>${student.yearLevel}</td>
                            <td>${student.classNames.join(', ')}</td>
                        `;
                        studentsList.appendChild(row);
                    });
                }
            })
            .catch(error => {
                console.error('Error loading students:', error);
                document.getElementById('studentsList').innerHTML = 
                    '<tr><td colspan="4" class="text-center text-danger">Error loading students</td></tr>';
            });
        
        // Load attendance overview
        fetch('/instructors/api/class-attendance-overview')
            .then(response => response.json())
            .then(classes => {
                let totalPresent = 0;
                let totalEnrolled = 0;
                
                classes.forEach(cls => {
                    totalPresent += cls.presentCount;
                    totalEnrolled += cls.enrolledCount;
                });
                
                // Calculate total absent
                const totalAbsent = totalEnrolled - totalPresent;
                
                // Update counters
                document.getElementById('presentCount').textContent = totalPresent;
                document.getElementById('absentCount').textContent = totalAbsent;
            })
            .catch(error => {
                console.error('Error loading attendance:', error);
            });
    }
});
</script>
{% endblock %}